<?php

namespace App\Services;

use App\Models\AuditLog;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Request;

class AuditLogService
{
    /**
     * Create an audit log entry
     *
     * @param Model $model The model being audited
     * @param string $action The action performed (created, updated, deleted, approved, rejected, etc.)
     * @param array|null $oldValues Previous state of the model
     * @param array|null $newValues New state of the model
     * @param array|null $metadata Additional context
     * @return AuditLog
     */
    public static function log(
        Model $model,
        string $action,
        ?array $oldValues = null,
        ?array $newValues = null,
        ?array $metadata = null
    ): AuditLog {
        return AuditLog::create([
            'user_id' => Auth::id(),
            'auditable_type' => get_class($model),
            'auditable_id' => $model->id,
            'action' => $action,
            'old_values' => $oldValues,
            'new_values' => $newValues,
            'metadata' => $metadata,
            'ip_address' => Request::ip(),
        ]);
    }

    /**
     * Log user login
     */
    public static function logLogin($userId): AuditLog
    {
        return AuditLog::create([
            'user_id' => $userId,
            'auditable_type' => 'App\Models\User',
            'auditable_id' => $userId,
            'action' => 'login',
            'old_values' => null,
            'new_values' => null,
            'metadata' => [
                'user_agent' => Request::header('User-Agent'),
                'timestamp' => now()->toDateTimeString(),
            ],
            'ip_address' => Request::ip(),
        ]);
    }

    /**
     * Log user logout
     */
    public static function logLogout($userId): AuditLog
    {
        return AuditLog::create([
            'user_id' => $userId,
            'auditable_type' => 'App\Models\User',
            'auditable_id' => $userId,
            'action' => 'logout',
            'old_values' => null,
            'new_values' => null,
            'metadata' => [
                'timestamp' => now()->toDateTimeString(),
            ],
            'ip_address' => Request::ip(),
        ]);
    }

    /**
     * Log configuration change
     */
    public static function logConfigChange(
        Model $config,
        array $oldValues,
        array $newValues
    ): AuditLog {
        return static::log(
            $config,
            'config_updated',
            $oldValues,
            $newValues,
            [
                'changed_fields' => array_keys(array_diff_assoc($newValues, $oldValues)),
                'updated_by_name' => Auth::user()->name ?? 'System',
            ]
        );
    }

    /**
     * Log booking status change
     */
    public static function logBookingStatusChange(
        Model $booking,
        string $oldStatus,
        string $newStatus,
        ?string $reason = null
    ): AuditLog {
        return static::log(
            $booking,
            'status_changed',
            ['status' => $oldStatus],
            ['status' => $newStatus],
            [
                'old_status' => $oldStatus,
                'new_status' => $newStatus,
                'reason' => $reason,
                'changed_by_name' => Auth::user()->name ?? 'System',
            ]
        );
    }

    /**
     * Get audit trail for a specific model
     */
    public static function getAuditTrail(Model $model, int $limit = 50): \Illuminate\Database\Eloquent\Collection
    {
        return AuditLog::where('auditable_type', get_class($model))
            ->where('auditable_id', $model->id)
            ->with('user')
            ->orderBy('created_at', 'desc')
            ->limit($limit)
            ->get();
    }

    /**
     * Get recent audit logs for a user
     */
    public static function getUserActivity(int $userId, int $limit = 50): \Illuminate\Database\Eloquent\Collection
    {
        return AuditLog::where('user_id', $userId)
            ->orderBy('created_at', 'desc')
            ->limit($limit)
            ->get();
    }

    /**
     * Get all audit logs with filters
     */
    public static function getFilteredLogs(
        ?string $modelType = null,
        ?int $userId = null,
        ?string $action = null,
        ?int $days = 30
    ): \Illuminate\Database\Eloquent\Builder {
        $query = AuditLog::with('user');

        if ($modelType) {
            $query->where('auditable_type', $modelType);
        }

        if ($userId) {
            $query->where('user_id', $userId);
        }

        if ($action) {
            $query->where('action', $action);
        }

        if ($days) {
            $query->where('created_at', '>=', now()->subDays($days));
        }

        return $query->orderBy('created_at', 'desc');
    }
}
